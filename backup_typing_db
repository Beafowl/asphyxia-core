type Without<T, K> = Pick<T, Exclude<keyof T, K>>;
type ValueOf<T> = T[keyof T];
type ArrayOf<T> = T[Exclude<keyof T, keyof Array<any>>];
type SubArrayOf<T, U extends keyof T> = ArrayOf<T[U]>;
type ConditionalValueOf<T, U extends keyof T> = T[U];

type TypedQueryOperator<U> = { $lt: U } | { $lte: U } | { $gt: U } | { $gte: U } | { $in: U[] };
type TypedArrayQueryOperator<U> = { $elemMatch: U };
type UnknownArrayQueryOperator = { $size: number };
type UnknownQueryOperator = { $ne: any } | { $nin: any[] } | { $exists: boolean };
type RegexQueryOperator = { $regex: RegExp };

type WithID = { _id: string };

type QueryResult<T extends any> = {
  [P in keyof Without<T, '$where' | '$or' | '$and' | '$not'>]: T[P] extends TypedQueryOperator<
    infer U
  >
    ? U
    : T[P] extends UnknownQueryOperator
    ? any
    : T[P] extends RegexQueryOperator
    ? string
    : T[P] extends TypedArrayQueryOperator<infer U>
    ? Partial<U>[]
    : T[P] extends UnknownArrayQueryOperator
    ? any[]
    : T[P] extends object
    ? QueryResult<T[P]>
    : T[P];
} &
  {
    [P in keyof SubArrayOf<T, '$or'>]: ValueOf<SubArrayOf<T, '$or'>>;
  } &
  {
    [P in keyof SubArrayOf<T, '$and'>]-?: ValueOf<SubArrayOf<T, '$and'>>;
  } &
  {
    [P in keyof ConditionalValueOf<T, '$not'>]: any;
  } &
  WithID & {
    [key: string]: any;
  };

type UpdateQueryDoc<U> = {};

type UpdateResult<T, U> = {
  updated: number;
  docs: (Partial<QueryResult<T>> & UpdateQueryDoc<U>)[];
};

declare namespace DB {
  function FindOne<T>(refid: string, query: T): Promise<QueryResult<T>>;
  function FindOne<T>(query: T): Promise<QueryResult<T>>;

  function Find<T>(refid: string, query: T): Promise<QueryResult<T>>;
  function Find<T>(query: T): Promise<QueryResult<T>>;

  function Insert<T>(refid: string, doc: T): Promise<T & WithID>;
  function Insert<T>(doc: T): Promise<T & WithID>;

  function Remove(refid: string, query: any): Promise<number>;
  function Remove(query: any): Promise<number>;

  function Update<T, U>(refid: string, query: T, update: U): Promise<UpdateResult<T, U>>;
  function Update<T, U>(query: T, update: U): Promise<UpdateResult<T, U>>;

  function Upsert<T, U>(refid: string, query: T, update: U): Promise<UpdateResult<T, U>>;
  function Upsert<T, U>(query: T, update: U): Promise<UpdateResult<T, U>>;
}
